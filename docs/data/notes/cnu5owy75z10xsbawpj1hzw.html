<h1 id="列表字典-集合推导式"><a aria-hidden="true" class="anchor-heading icon-link" href="#列表字典-集合推导式"></a>列表（字典， 集合）推导式</h1>
<h2 id="基本用法"><a aria-hidden="true" class="anchor-heading icon-link" href="#基本用法"></a>基本用法</h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">assert</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span>
<span class="token keyword">assert</span> <span class="token punctuation">{</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span>
<span class="token keyword">assert</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token number">81</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="内部实现"><a aria-hidden="true" class="anchor-heading icon-link" href="#内部实现"></a>内部实现</h2>
<p>使用<code>get_iter</code>指令，效率高于 map/filter 函数</p>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> dis
<span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span><span class="token string">"[x for x in 'abc']"</span><span class="token punctuation">)</span>
<span class="token number">1</span>           <span class="token number">0</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token operator">&#x3C;</span>code <span class="token builtin">object</span> <span class="token operator">&#x3C;</span>listcomp<span class="token operator">></span> at <span class="token number">0x000001F3D5502E40</span><span class="token punctuation">,</span> <span class="token builtin">file</span> <span class="token string">"&#x3C;dis>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token operator">></span><span class="token punctuation">)</span>
              <span class="token number">2</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token string">'&#x3C;listcomp>'</span><span class="token punctuation">)</span>
              <span class="token number">4</span> MAKE_FUNCTION            <span class="token number">0</span>
              <span class="token number">6</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span>
              <span class="token number">8</span> GET_ITER
             <span class="token number">10</span> CALL_FUNCTION            <span class="token number">1</span>
             <span class="token number">12</span> RETURN_VALUE

Disassembly of <span class="token operator">&#x3C;</span>code <span class="token builtin">object</span> <span class="token operator">&#x3C;</span>listcomp<span class="token operator">></span> at <span class="token number">0x000001F3D5502E40</span><span class="token punctuation">,</span> <span class="token builtin">file</span> <span class="token string">"&#x3C;dis>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token operator">></span><span class="token punctuation">:</span>
  <span class="token number">1</span>           <span class="token number">0</span> BUILD_LIST               <span class="token number">0</span>
              <span class="token number">2</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">.0</span><span class="token punctuation">)</span>
        <span class="token operator">>></span>    <span class="token number">4</span> FOR_ITER                 <span class="token number">4</span> <span class="token punctuation">(</span>to <span class="token number">14</span><span class="token punctuation">)</span>
              <span class="token number">6</span> STORE_FAST               <span class="token number">1</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
              <span class="token number">8</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
             <span class="token number">10</span> LIST_APPEND              <span class="token number">2</span>
             <span class="token number">12</span> JUMP_ABSOLUTE            <span class="token number">2</span> <span class="token punctuation">(</span>to <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token operator">>></span>   <span class="token number">14</span> RETURN_VALUE
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> timeit
comprehension <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span><span class="token string">"[x.upper() for x in 'abc']"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
map_function <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span><span class="token string">"list(map(str.upper, 'abc'))"</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>comprehension<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string"> vs </span><span class="token interpolation"><span class="token punctuation">{</span>map_function<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

comprehension<span class="token operator">=</span><span class="token number">0.003946700002416037</span> vs map_function<span class="token operator">=</span><span class="token number">0.0069931999896653</span>
</code></pre>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/notes/i7qra5ip0gwchs30f5at7rx">Python</a></li>
<li><a href="/notes/gi59c2928gvbae6n3uniugg">内置类型</a></li>
</ul>